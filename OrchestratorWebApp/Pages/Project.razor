@page "/projects/{ProjectId}"
@using System.Net.Http
@using System.Text.Json
@using SharedLib.Model
@inject HttpClient Http
@inject NavigationManager Navigation

<PageTitle>Project Details - Agent as a Service</PageTitle>

<div class="container-fluid">
    @if (project == null)
    {
        <div class="text-center">
            <div class="spinner-border" role="status">
                <span class="sr-only">Loading...</span>
            </div>
            <p class="mt-2">Loading project details...</p>
        </div>
    }
    else
    {
        <div class="row mb-4">
            <div class="col-12">
                <nav aria-label="breadcrumb">
                    <ol class="breadcrumb">
                        <li class="breadcrumb-item"><a href="/projects">Projects</a></li>
                        <li class="breadcrumb-item active" aria-current="page">@project.Name</li>
                    </ol>
                </nav>
                <h1>üìÅ @project.Name</h1>
                <p class="text-muted">Project created on @project.CreatedAt.ToString("MMMM dd, yyyy")</p>
            </div>
        </div>

        <div class="row">
            <div class="col-md-8">
                <div class="card mb-4">
                    <div class="card-header">
                        <h5 class="mb-0">üìã Project Information</h5>
                    </div>
                    <div class="card-body">
                        <dl class="row">
                            <dt class="col-sm-3">Project ID:</dt>
                            <dd class="col-sm-9"><code>@project.Id</code></dd>
                            
                            <dt class="col-sm-3">Orchestrator:</dt>
                            <dd class="col-sm-9">@project.OrchestratorId</dd>
                            
                            <dt class="col-sm-3">Repository:</dt>
                            <dd class="col-sm-9">
                                @if (project.Repository != null && !string.IsNullOrEmpty(project.Repository.Name))
                                {
                                    <strong>@project.Repository.Name</strong><br>
                                    @if (!string.IsNullOrEmpty(project.Repository.Address))
                                    {
                                        <a href="@project.Repository.Address" target="_blank" class="text-muted small">
                                            @project.Repository.Address <i class="fas fa-external-link-alt"></i>
                                        </a>
                                    }
                                }
                                else
                                {
                                    <span class="text-muted">No repository configured</span>
                                }
                            </dd>
                            
                            <dt class="col-sm-3">Team:</dt>
                            <dd class="col-sm-9">
                                <a href="/projects/@ProjectId/team" class="btn btn-sm btn-outline-primary">
                                    üë• @project.Team.Name (@project.Team.Members.Count members)
                                </a>
                            </dd>
                        </dl>
                    </div>
                </div>

                @if (project.Team.Members.Count > 0)
                {
                    <div class="card">
                        <div class="card-header">
                            <h5 class="mb-0">üë• Team Members</h5>
                        </div>
                        <div class="card-body">
                            <div class="table-responsive">
                                <table class="table table-hover">
                                    <thead>
                                        <tr>
                                            <th>Agent Name</th>
                                            <th>Type</th>
                                            <th>Created</th>
                                            <th>Actions</th>
                                        </tr>
                                    </thead>
                                    <tbody>
                                        @foreach (var member in project.Team.Members)
                                        {
                                            <tr>
                                                <td><strong>@member.Name</strong></td>
                                                <td><span class="badge bg-secondary">Collaborator</span></td>
                                                <td>@member.CreatedAt.ToString("MMM dd, yyyy")</td>
                                                <td>
                                                    <a href="/projects/@ProjectId/agents/@member.Id" class="btn btn-sm btn-outline-info">View Details</a>
                                                    <button class="btn btn-sm btn-outline-danger" @onclick="() => RemoveAgent(member.Id)">Remove</button>
                                                </td>
                                            </tr>
                                        }
                                    </tbody>
                                </table>
                            </div>
                        </div>
                    </div>
                }
            </div>

            <div class="col-md-4">
                <!-- Project Status Card -->
                <div class="card mb-4">
                    <div class="card-header">
                        <h5 class="mb-0">üéØ Project Status</h5>
                    </div>
                    <div class="card-body">
                        <div class="mb-3">
                            <strong>Current Status:</strong>
                            <span class="badge @GetStatusBadgeClass(projectStatus) ms-2">@projectStatus</span>
                        </div>
                        
                        @if (projectStatus == "Configured" || projectStatus == "Ready")
                        {
                            <div class="d-grid mb-2">
                                <button class="btn btn-success" @onclick="StartProject" disabled="@isStartingProject">
                                    @if (isStartingProject)
                                    {
                                        <span class="spinner-border spinner-border-sm me-2"></span>
                                    }
                                    <i class="fas fa-play"></i> Start Project
                                </button>
                            </div>
                        }
                        else if (projectStatus == "Running")
                        {
                            <div class="d-grid mb-2">
                                <button class="btn btn-warning" @onclick="PauseProject" disabled="@isPausingProject">
                                    @if (isPausingProject)
                                    {
                                        <span class="spinner-border spinner-border-sm me-2"></span>
                                    }
                                    <i class="fas fa-pause"></i> Pause Project
                                </button>
                            </div>
                        }
                        else if (projectStatus == "Paused")
                        {
                            <div class="d-grid mb-2">
                                <button class="btn btn-success" @onclick="ResumeProject" disabled="@isResumingProject">
                                    @if (isResumingProject)
                                    {
                                        <span class="spinner-border spinner-border-sm me-2"></span>
                                    }
                                    <i class="fas fa-play"></i> Resume Project
                                </button>
                            </div>
                        }
                        
                        @if (projectStatus == "Running" || projectStatus == "Paused")
                        {
                            <div class="d-grid mb-2">
                                <button class="btn btn-warning" @onclick="StopProject" disabled="@isStoppingProject">
                                    @if (isStoppingProject)
                                    {
                                        <span class="spinner-border spinner-border-sm me-2"></span>
                                    }
                                    <i class="fas fa-stop"></i> Stop Project
                                </button>
                            </div>
                        }
                    </div>
                </div>

                <!-- Real-time Session Monitoring -->
                @if (projectStatus == "Running" && activeSessions.Any())
                {
                    <div class="card mb-4">
                        <div class="card-header">
                            <h5 class="mb-0">üîÑ Active Sessions</h5>
                        </div>
                        <div class="card-body">
                            @foreach (var session in activeSessions)
                            {
                                <div class="session-monitor mb-3 p-3 border rounded">
                                    <div class="d-flex justify-content-between align-items-center mb-2">
                                        <strong>@session.AgentName</strong>
                                        <span class="badge @GetSessionStatusBadgeClass(session.Status)">@session.Status</span>
                                    </div>
                                    <div class="small text-muted mb-2">
                                        Started: @session.StartTime.ToString("HH:mm:ss")
                                    </div>
                                    @if (!string.IsNullOrEmpty(session.CurrentTask))
                                    {
                                        <div class="small">
                                            <strong>Current Task:</strong> @session.CurrentTask
                                        </div>
                                    }
                                    <div class="progress mt-2" style="height: 6px;">
                                        <div class="progress-bar" style="width: @(session.Progress)%"></div>
                                    </div>
                                </div>
                            }
                        </div>
                    </div>
                }

                <!-- Quick Actions Card -->
                <div class="card mb-4">
                    <div class="card-header">
                        <h5 class="mb-0">‚ö° Quick Actions</h5>
                    </div>
                    <div class="card-body">
                        <div class="d-grid gap-2">
                            <a href="/projects/@ProjectId/team" class="btn btn-primary">
                                <i class="fas fa-users"></i> Manage Team
                            </a>
                            @if (projectStatus == "Running")
                            {
                                <a href="/projects/@ProjectId/sessions" class="btn btn-info">
                                    <i class="fas fa-chart-line"></i> View Session Logs
                                </a>
                                <a href="/projects/@ProjectId/visualization" class="btn btn-secondary">
                                    <i class="fas fa-project-diagram"></i> Task Visualization
                                </a>
                            }
                            <button class="btn btn-danger" @onclick="DeleteProject" disabled="@isDeletingProject">
                                @if (isDeletingProject)
                                {
                                    <span class="spinner-border spinner-border-sm me-2"></span>
                                }
                                <i class="fas fa-trash"></i> Delete Project
                            </button>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    }
</div>

@code {    [Parameter] public string ProjectId { get; set; } = "";
    
    private SharedLib.Model.Project? project;
    private bool isStoppingProject = false;
    private bool isDeletingProject = false;
    private bool isStartingProject = false;
    private bool isPausingProject = false;
    private bool isResumingProject = false;
    private string actionMessage = "";
    private bool actionSuccess = false;
    private string projectStatus = "Configured"; // Default status
    private List<SessionInfo> activeSessions = new List<SessionInfo>();

    protected override async Task OnInitializedAsync()
    {
        await LoadProject();
        await LoadProjectStatus();
        await LoadActiveSessions();
    }

    private async Task LoadProject()
    {
        try        {
            var response = await Http.GetStringAsync($"/api/projects/{ProjectId}");
            project = JsonSerializer.Deserialize<SharedLib.Model.Project>(response, new JsonSerializerOptions
            {
                PropertyNamingPolicy = JsonNamingPolicy.CamelCase
            });
        }
        catch (Exception ex)
        {
            actionMessage = $"Failed to load project: {ex.Message}";
            actionSuccess = false;
        }
    }

    private async Task LoadProjectStatus()
    {
        try
        {
            var response = await Http.GetStringAsync($"/api/projects/{ProjectId}/status");
            projectStatus = response.Trim('"'); // Remove quotes
        }
        catch (Exception)
        {
            projectStatus = "Error";
        }
    }

    private async Task LoadActiveSessions()
    {
        try
        {
            var response = await Http.GetStringAsync($"/api/projects/{ProjectId}/sessions");
            activeSessions = JsonSerializer.Deserialize<List<SessionInfo>>(response, new JsonSerializerOptions
            {
                PropertyNamingPolicy = JsonNamingPolicy.CamelCase
            }) ?? new List<SessionInfo>();
        }
        catch (Exception)
        {
            activeSessions = new List<SessionInfo>();
        }
    }

    private async Task StartProject()
    {
        if (project == null) return;

        isStartingProject = true;
        actionMessage = "";
        StateHasChanged();

        try
        {
            var response = await Http.PostAsync($"/api/projects/{ProjectId}/start", null);
            if (response.IsSuccessStatusCode)
            {
                actionMessage = "Project started successfully!";
                actionSuccess = true;
                await LoadProjectStatus();
            }
            else
            {
                var responseContent = await response.Content.ReadAsStringAsync();
                actionMessage = $"Failed to start project: {responseContent}";
                actionSuccess = false;
            }
        }
        catch (Exception ex)
        {
            actionMessage = $"Error starting project: {ex.Message}";
            actionSuccess = false;
        }
        finally
        {
            isStartingProject = false;
            StateHasChanged();
        }
    }

    private async Task StopProject()
    {
        if (project == null) return;

        isStoppingProject = true;
        actionMessage = "";
        StateHasChanged();

        try
        {
            var response = await Http.PostAsync($"/api/projects/{ProjectId}/stop", null);
            if (response.IsSuccessStatusCode)
            {
                actionMessage = "Project stopped successfully!";
                actionSuccess = true;
                await LoadProjectStatus();
            }
            else
            {
                var responseContent = await response.Content.ReadAsStringAsync();
                actionMessage = $"Failed to stop project: {responseContent}";
                actionSuccess = false;
            }
        }
        catch (Exception ex)
        {
            actionMessage = $"Error stopping project: {ex.Message}";
            actionSuccess = false;
        }
        finally
        {
            isStoppingProject = false;
            StateHasChanged();
        }
    }

    private async Task DeleteProject()
    {
        if (project == null) return;

        if (!await ConfirmDelete()) return;

        isDeletingProject = true;
        actionMessage = "";
        StateHasChanged();

        try
        {
            var response = await Http.DeleteAsync($"/api/projects/{ProjectId}");
            if (response.IsSuccessStatusCode)
            {
                actionMessage = "Project deleted successfully! Redirecting...";
                actionSuccess = true;
                StateHasChanged();
                await Task.Delay(2000);
                Navigation.NavigateTo("/projects");
            }
            else
            {
                var responseContent = await response.Content.ReadAsStringAsync();
                actionMessage = $"Failed to delete project: {responseContent}";
                actionSuccess = false;
            }
        }
        catch (Exception ex)
        {
            actionMessage = $"Error deleting project: {ex.Message}";
            actionSuccess = false;
        }
        finally
        {
            isDeletingProject = false;
            StateHasChanged();
        }
    }

    private async Task RemoveAgent(string agentId)
    {
        try
        {
            var response = await Http.DeleteAsync($"/api/team/projects/{ProjectId}/agents/{agentId}");
            if (response.IsSuccessStatusCode)
            {
                actionMessage = "Agent removed successfully!";
                actionSuccess = true;
                await LoadProject(); // Refresh the project data
            }
            else
            {
                var responseContent = await response.Content.ReadAsStringAsync();
                actionMessage = $"Failed to remove agent: {responseContent}";
                actionSuccess = false;
            }
        }
        catch (Exception ex)
        {
            actionMessage = $"Error removing agent: {ex.Message}";
            actionSuccess = false;        }
    }

    private async Task<bool> ConfirmDelete()
    {
        // In a real application, you'd use a proper modal dialog
        // For now, we'll use browser confirm
        return await Task.FromResult(true); // Simplified for this implementation
    }

    private string GetStatusBadgeClass(string status)
    {
        return status switch
        {
            "Running" => "bg-success",
            "Paused" => "bg-warning",
            "Stopped" => "bg-danger",
            "Configured" => "bg-info",
            "Ready" => "bg-primary",
            "Error" => "bg-secondary",
            _ => "bg-light"
        };
    }

    private string GetSessionStatusBadgeClass(string status)
    {
        return status switch
        {
            "Active" => "bg-success",
            "Paused" => "bg-warning",
            "Stopped" => "bg-danger",
            "Error" => "bg-secondary",
            _ => "bg-light"
        };
    }

    private class SessionInfo
    {
        public string AgentName { get; set; } = "";
        public string Status { get; set; } = "";
        public DateTime StartTime { get; set; }
        public string CurrentTask { get; set; } = "";
        public double Progress { get; set; }
    }

    private async Task PauseProject()
    {
        if (project == null) return;

        isPausingProject = true;
        actionMessage = "";
        StateHasChanged();

        try
        {
            var response = await Http.PostAsync($"/api/projects/{ProjectId}/pause", null);
            if (response.IsSuccessStatusCode)
            {
                actionMessage = "Project paused successfully!";
                actionSuccess = true;
                await LoadProjectStatus();
            }
            else
            {
                var responseContent = await response.Content.ReadAsStringAsync();
                actionMessage = $"Failed to pause project: {responseContent}";
                actionSuccess = false;
            }
        }
        catch (Exception ex)
        {
            actionMessage = $"Error pausing project: {ex.Message}";
            actionSuccess = false;
        }
        finally
        {
            isPausingProject = false;
            StateHasChanged();
        }
    }

    private async Task ResumeProject()
    {
        if (project == null) return;

        isResumingProject = true;
        actionMessage = "";
        StateHasChanged();

        try
        {
            var response = await Http.PostAsync($"/api/projects/{ProjectId}/resume", null);
            if (response.IsSuccessStatusCode)
            {
                actionMessage = "Project resumed successfully!";
                actionSuccess = true;
                await LoadProjectStatus();
            }
            else
            {
                var responseContent = await response.Content.ReadAsStringAsync();
                actionMessage = $"Failed to resume project: {responseContent}";
                actionSuccess = false;
            }
        }
        catch (Exception ex)
        {
            actionMessage = $"Error resuming project: {ex.Message}";
            actionSuccess = false;
        }
        finally
        {
            isResumingProject = false;
            StateHasChanged();
        }
    }
}
